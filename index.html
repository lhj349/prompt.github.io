<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AI æç¤ºè¯ç¥å™¨ (é«˜çº§æ’åºå®šåˆ¶ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #0a0a0c; --card-bg: #16161a; --text-main: #f0f0f5; --text-sub: #a1a1aa;
            --accent: #6366f1; --accent-hover: #818cf8; --border: #27272a; --tag-bg: #222226;
            --tag-selected: #6366f1; --input-bg: #09090b; --panel-bg: rgba(10, 10, 12, 0.98);
            --success: #10b981; --danger: #ef4444;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }
        body.light-theme {
            --bg-color: #f4f4f5; --card-bg: #ffffff; --text-main: #18181b; --text-sub: #52525b;
            --accent: #4f46e5; --accent-hover: #6366f1; --border: #e4e4e7; --tag-bg: #f1f1f4;
            --tag-selected: #4f46e5; --input-bg: #ffffff; --panel-bg: rgba(255, 255, 255, 0.98);
            --modal-overlay: rgba(0, 0, 0, 0.4);
        }
        body {
            background-color: var(--bg-color); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 12px; display: flex; justify-content: center;
            transition: background-color 0.2s; -webkit-tap-highlight-color: transparent;
            font-size: 14px; line-height: 1.5;
        }
        .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 16px; padding-bottom: var(--panel-height, 300px); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; position: relative; }
        h1 { margin: 0; color: var(--accent); font-size: 1.4rem; letter-spacing: -0.5px; }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-toggle { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border); cursor: pointer; font-size: 18px; }
        .settings-dropdown { position: absolute; top: 45px; right: 0; width: 260px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: none; transform-origin: top right; animation: scaleIn 0.2s ease; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .settings-dropdown.open { display: block; }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-switcher { display: flex; background: var(--card-bg); border: 1px solid var(--border); padding: 4px; border-radius: 12px; margin-bottom: 4px; }
        .mode-btn { flex: 1; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-sub); }
        .mode-btn.active { background: var(--accent); color: white; }

        /* æ¨¡å—å¡ç‰‡ä¸æ’åº */
        .module-card { background-color: var(--card-bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border); cursor: default; }
        .module-header { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .module-header:active { cursor: grabbing; }
        .module-del { color: var(--danger); font-size: 11px; font-weight: normal; cursor: pointer; padding: 4px; }

        /* åˆ†ç±»é¡µç­¾ä¸æ’åº */
        .category-bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .cat-tab { font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--tag-bg); color: var(--text-sub); cursor: grab; border: 1px solid var(--border); display: flex; align-items: center; gap: 4px; }
        .cat-tab.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: 600; }
        .cat-close { font-size: 14px; margin-left: 2px; cursor: pointer; opacity: 0.7; }
        .cat-close:hover { opacity: 1; color: #ffcccc; }

        /* æ ‡ç­¾è¯ä¸æ’åº */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .tag { background-color: var(--tag-bg); border: 1px solid var(--border); padding: 8px 14px; border-radius: 20px; font-size: 13px; cursor: grab; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .tag.active { background-color: var(--tag-selected); color: white; border-color: var(--tag-selected); }
        .tag-close { font-size: 16px; opacity: 0.6; cursor: pointer; }
        
        .dragging { opacity: 0.4; transform: scale(0.95); }

        input[type="text"], input[type="number"], input[type="password"] { background-color: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 8px; outline: none; font-size: 14px; width: 100%; box-sizing: border-box; }

        /* åº•éƒ¨é¢æ¿ */
        .bottom-panel { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--panel-bg); border-top: 1px solid var(--border); z-index: 100; display: flex; flex-direction: column; backdrop-filter: blur(16px); height: var(--panel-height, 280px); }
        .resize-handle { width: 100%; height: 16px; cursor: ns-resize; display: flex; justify-content: center; align-items: center; }
        .resize-handle::after { content: ""; width: 40px; height: 5px; background: var(--border); border-radius: 3px; }
        .panel-inner { flex: 1; display: flex; flex-direction: column; padding: 0 16px 12px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .toggle-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-toggle { flex: 1; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: 600; text-align: center; border: 1px solid var(--border); background: var(--tag-bg); color: var(--text-sub); cursor: pointer; }
        .btn-toggle.active { background: var(--accent); color: white; }
        textarea { flex: 1; background-color: var(--input-bg); border: 1px solid var(--border); color: var(--accent); padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; resize: none; line-height: 1.5; font-family: inherit; }
        .main-actions { display: flex; gap: 8px; width: 100%; }
        .btn { flex: 1; border: none; border-radius: 10px; padding: 12px 0; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-clear { background: var(--tag-bg); color: var(--text-main); border: 1px solid var(--border); flex: 0.6; }
        .btn-gen { background-color: var(--accent); color: white; flex: 1.2; }
        .btn-copy { background-color: var(--accent); color: white; }
        .history-list { background: var(--tag-bg); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; overflow-y: auto; display: none; max-height: 90px; }
        .history-list.open { display: block; }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; display: flex; justify-content: space-between; cursor: pointer; }

        /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
        #modalContainer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--modal-overlay); z-index: 2000; 
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-box { 
            background: var(--card-bg); border: 1px solid var(--border); 
            width: 90%; max-width: 320px; border-radius: 16px; padding: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: modalIn 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes modalIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--accent); }
        .modal-msg { font-size: 14px; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; }
        .modal-input { margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-small { padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--tag-bg); color: var(--text-main); cursor: pointer; font-size: 12px; }
        .btn-small.primary { background: var(--accent); color: white; border: none; }

        @media (max-width: 480px) { h1 { font-size: 1.2rem; } .btn span { display: none; } }
    </style>
</head>
<body class="dark-theme">

<div class="container">
    <div class="header-bar">
        <div>
            <h1>AI æç¤ºè¯ç¥å™¨</h1>
            <div style="font-size: 11px; color: var(--text-sub);">é•¿æŒ‰é¡µç­¾/æ ‡ç­¾å¯æ‹–æ‹½æ’åº</div>
        </div>
        <div class="settings-toggle" onclick="toggleSettingsPanel(event)">âš™ï¸</div>
        <div class="settings-dropdown" id="settingsDropdown">
            <div class="settings-item">
                <label>DeepSeek API Key</label>
                <input type="password" id="apiKeyInput" placeholder="å›è½¦ä¿å­˜" 
                       onkeydown="if(event.key==='Enter') { saveSettings(); document.getElementById('settingsDropdown').classList.remove('open'); }"
                       onblur="saveSettings()">
            </div>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn-small" onclick="toggleTheme()" id="themeBtn" style="flex:1">â˜€ï¸ ä¸»é¢˜</button>
                <button class="btn-small" onclick="resetAll()" style="color:var(--danger); flex:1">é‡ç½®</button>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 8px;">
                <button class="btn-small" onclick="exportData()" style="flex:1">å¯¼å‡º</button>
                <button class="btn-small" onclick="document.getElementById('importFile').click()" style="flex:1">å¯¼å…¥</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            </div>
        </div>
    </div>

    <div class="mode-switcher">
        <div class="mode-btn active" id="mode-char" onclick="switchMode('character')">ğŸ‘¤ è§’è‰²æ¨¡å¼</div>
        <div class="mode-btn" id="mode-prod" onclick="switchMode('product')">ğŸ äº§å“æ¨¡å¼</div>
    </div>

    <div class="module-card">
        <div class="module-header" style="cursor:default">ä¸»ä½“ä¿¡æ¯</div>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div id="ageBox" style="width: 60px;">
                <input type="number" id="ageInput" placeholder="å²" oninput="saveState()">
            </div>
            <div style="flex: 1;">
                <div class="tags-container" id="basicTags"></div>
                <div style="display:flex; gap:6px;">
                    <input type="text" id="basicInput" placeholder="ä¸»ä½“è¯+å›è½¦..." onkeydown="if(event.key==='Enter') addBasicTag()">
                    <button class="btn-small" onclick="addBasicTag()" style="padding:0 15px;">ï¼‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dynamicModules" style="display: flex; flex-direction: column; gap: 16px;"></div>

    <div style="border: 2px dashed var(--border); border-radius: 12px; padding: 18px; text-align: center; color: var(--text-sub); font-size: 13px; cursor: pointer; margin-bottom: 20px;" onclick="addNewModule()">
        ï¼‹ æ·»åŠ è‡ªå®šä¹‰å¤§æ¨¡å—
    </div>
</div>

<div class="bottom-panel" id="bottomPanel">
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="panel-inner">
        <div style="display:flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-bottom: 8px;">
            <span onclick="toggleHistory()" style="cursor:pointer">ğŸ•’ å†å² (<span id="histCount">0</span>)</span>
            <span onclick="clearAllHistory()" style="cursor:pointer">æ¸…ç©º</span>
        </div>
        <div class="history-list" id="historyList"></div>
        <div class="toggle-group">
            <div class="btn-toggle" id="aiToggle" onclick="toggleBtnState('useAI')">AI æ¶¦è‰²: OFF</div>
            <div class="btn-toggle" id="specialToggle" onclick="toggleBtnState('useSpecial')">æ¢è£…å‚è€ƒ: OFF</div>
        </div>
        <textarea id="resultBox" placeholder="é€‰å¥½æ ‡ç­¾åç”Ÿæˆ..."></textarea>
        <div class="main-actions">
            <button class="btn btn-clear" onclick="clearResult()">æ¸…ç©º</button>
            <button class="btn btn-gen" id="genBtn" onclick="generatePrompt()">ğŸš€<span>ç”Ÿæˆè¯</span></button>
            <button class="btn btn-copy" id="copyBtn" onclick="copyResult()">ğŸ“‹<span>å¤åˆ¶</span></button>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰å¼¹çª—å®¹å™¨ -->
<div id="modalContainer">
    <div class="modal-box">
        <div class="modal-title" id="modalTitle">æç¤ºè¯åŠ©æ‰‹</div>
        <div class="modal-msg" id="modalMsg"></div>
        <div class="modal-input" id="modalInputWrap" style="display:none">
            <input type="text" id="modalInput" placeholder="è¯·è¾“å…¥...">
        </div>
        <div class="modal-btns">
            <button class="btn-small" id="modalCancel">å–æ¶ˆ</button>
            <button class="btn-small primary" id="modalConfirm">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    let appState = {
        mode: 'character', theme: 'dark', panelHeight: 280, age: '', apiKey: '', useAI: false, history: [],
        charData: { subjects: ['å°‘å¥³', 'ç”·æ€§'], modules: [], selSubject: null, selTags: {}, useSpecial: false },
        prodData: { subjects: ['é¦™æ°´', 'è¿åŠ¨é‹'], modules: [], selSubject: null, selTags: {}, useSpecial: false }
    };

    // --- è‡ªå®šä¹‰å¼¹çª—ç³»ç»Ÿ ---
    function showModal({ title, msg, showInput = false, defaultValue = '' }) {
        return new Promise((resolve) => {
            const container = document.getElementById('modalContainer');
            const msgEl = document.getElementById('modalMsg');
            const titleEl = document.getElementById('modalTitle');
            const inputWrap = document.getElementById('modalInputWrap');
            const input = document.getElementById('modalInput');
            const cancelBtn = document.getElementById('modalCancel');
            const confirmBtn = document.getElementById('modalConfirm');

            titleEl.innerText = title || 'æç¤ºè¯åŠ©æ‰‹';
            msgEl.innerText = msg || '';
            container.style.display = 'flex';
            
            if (showInput) {
                inputWrap.style.display = 'block';
                input.value = defaultValue;
                setTimeout(() => input.focus(), 50);
            } else {
                inputWrap.style.display = 'none';
            }

            const cleanup = (val) => {
                container.style.display = 'none';
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                resolve(val);
            };

            confirmBtn.onclick = () => cleanup(showInput ? input.value : true);
            cancelBtn.onclick = () => cleanup(null);
        });
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        const saved = localStorage.getItem('prompt_v10_state');
        if (saved) appState = { ...appState, ...JSON.parse(saved) };
        
        if (!appState.charData.modules.length) appState.charData.modules = [{ id: 'm1', title: 'ğŸï¸ åœºæ™¯', activeCat: 0, categories: [{ name: 'æˆ·å¤–', tags: ['æ£®æ—', 'æµ·è¾¹'] }] }];
        if (!appState.prodData.modules.length) appState.prodData.modules = [{ id: 'p1', title: 'ğŸ§± æè´¨', activeCat: 0, categories: [{ name: 'åº•åº§', tags: ['å¤§ç†çŸ³'] }] }];

        updateUIThemes(); refreshModeUI(); updateHistoryUI(); updateToggleButtons();
        document.getElementById('apiKeyInput').value = appState.apiKey || '';
        document.getElementById('ageInput').value = appState.age || '';
        document.documentElement.style.setProperty('--panel-height', appState.panelHeight + 'px');
        initResize();
        
        document.addEventListener('click', (e) => {
            if (!document.getElementById('settingsDropdown').contains(e.target) && !e.target.closest('.settings-toggle')) document.getElementById('settingsDropdown').classList.remove('open');
        });
    }

    function switchMode(m) {
        appState.mode = m;
        document.getElementById('mode-char').classList.toggle('active', m === 'character');
        document.getElementById('mode-prod').classList.toggle('active', m === 'product');
        refreshModeUI(); updateToggleButtons(); saveState();
    }

    function refreshModeUI() {
        renderBasic(); renderModules();
    }

    // --- æ ¸å¿ƒæ¸²æŸ“ ---
    function renderBasic() {
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        document.getElementById('ageBox').style.display = appState.mode === 'character' ? 'block' : 'none';
        document.getElementById('basicTags').innerHTML = data.subjects.map((t, i) => `
            <div class="tag ${data.selSubject === t ? 'active' : ''}" 
                 draggable="true" ondragstart="handleDragStart(event, 'basic', ${i})" 
                 ondragover="event.preventDefault()" ondrop="handleDrop(event, 'basic', ${i})"
                 onclick="selectBasic('${t}')">
                ${t} <span class="tag-close" onclick="event.stopPropagation();delBasic('${t}')">Ã—</span>
            </div>`).join('');
    }

    function renderModules() {
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        const container = document.getElementById('dynamicModules');
        container.innerHTML = data.modules.map((m, mIdx) => `
            <div class="module-card" draggable="true" ondragstart="handleDragStart(event, 'module', ${mIdx})" ondragover="event.preventDefault()" ondrop="handleDrop(event, 'module', ${mIdx})">
                <div class="module-header">
                    ${m.title} <span class="module-del" onclick="deleteModule('${m.id}')">åˆ é™¤æ¨¡å—</span>
                </div>
                <div class="category-bar">
                    ${m.categories.map((c, cIdx) => `
                        <div class="cat-tab ${m.activeCat === cIdx ? 'active' : ''}" 
                             draggable="true" ondragstart="event.stopPropagation();handleDragStart(event, 'cat', ${cIdx}, '${m.id}')" 
                             ondragover="event.preventDefault()" ondrop="event.stopPropagation();handleDrop(event, 'cat', ${cIdx}, '${m.id}')"
                             onclick="setCat('${m.id}', ${cIdx})">
                            ${c.name}
                            <span class="cat-close" onclick="event.stopPropagation();deleteCat('${m.id}', ${cIdx})">Ã—</span>
                        </div>
                    `).join('')}
                    <div class="cat-tab" style="border-style:dashed; color:var(--accent)" onclick="addCat('${m.id}')">ï¼‹</div>
                </div>
                <div class="tags-container">
                    ${m.categories[m.activeCat].tags.map((t, tIdx) => `
                        <div class="tag ${(data.selTags[m.id]||[]).includes(t) ? 'active' : ''}" 
                             draggable="true" ondragstart="event.stopPropagation();handleDragStart(event, 'tag', ${tIdx}, '${m.id}')" 
                             ondragover="event.preventDefault()" ondrop="event.stopPropagation();handleDrop(event, 'tag', ${tIdx}, '${m.id}')"
                             onclick="toggleTag('${m.id}','${t}')">
                            ${t} <span class="tag-close" onclick="event.stopPropagation();delTag('${m.id}','${t}')">Ã—</span>
                        </div>
                    `).join('')}
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="in-${m.id}" placeholder="è¾“å…¥æ–°æ ‡ç­¾åå›è½¦..." onkeydown="if(event.key==='Enter') addTag('${m.id}')">
                    <button class="btn-small" onclick="addTag('${m.id}')">ï¼‹</button>
                </div>
            </div>
        `).join('');
    }

    // --- æ‹–æ‹½é€»è¾‘ ---
    let dragSource = null;
    function handleDragStart(e, type, index, mid = null) {
        dragSource = { type, index, mid };
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDrop(e, type, targetIndex, mid = null) {
        e.preventDefault();
        if (!dragSource || dragSource.type !== type || dragSource.mid !== mid) return;
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        if (type === 'basic') {
            const item = data.subjects.splice(dragSource.index, 1)[0];
            data.subjects.splice(targetIndex, 0, item);
        } else if (type === 'module') {
            const item = data.modules.splice(dragSource.index, 1)[0];
            data.modules.splice(targetIndex, 0, item);
        } else if (type === 'cat') {
            const m = data.modules.find(x => x.id === mid);
            const item = m.categories.splice(dragSource.index, 1)[0];
            m.categories.splice(targetIndex, 0, item);
            m.activeCat = targetIndex;
        } else if (type === 'tag') {
            const m = data.modules.find(x => x.id === mid);
            const tags = m.categories[m.activeCat].tags;
            const item = tags.splice(dragSource.index, 1)[0];
            tags.splice(targetIndex, 0, item);
        }
        renderModules(); renderBasic(); saveState();
    }

    // --- ä¸šåŠ¡é€»è¾‘ ---
    function addBasicTag() {
        const v = document.getElementById('basicInput').value.trim();
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        if(v && !data.subjects.includes(v)) { data.subjects.push(v); document.getElementById('basicInput').value = ''; renderBasic(); saveState(); }
    }

    function addTag(mid) {
        const v = document.getElementById(`in-${mid}`).value.trim();
        if(!v) return;
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        const m = data.modules.find(x => x.id === mid);
        if(!m.categories[m.activeCat].tags.includes(v)) { m.categories[m.activeCat].tags.push(v); renderModules(); saveState(); }
    }

    async function deleteCat(mid, cIdx) {
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        const m = data.modules.find(x => x.id === mid);
        if (m.categories.length <= 1) return showModal({msg: "è¯·è‡³å°‘ä¿ç•™ä¸€ä¸ªåˆ†ç±»"});
        const ok = await showModal({msg: `ç¡®å®šåˆ é™¤åˆ†ç±» [${m.categories[cIdx].name}] å—ï¼Ÿ`});
        if (ok) {
            m.categories.splice(cIdx, 1);
            m.activeCat = 0;
            renderModules(); saveState();
        }
    }

    async function addCat(mid) {
        const n = await showModal({msg: "è¯·è¾“å…¥æ–°åˆ†ç±»åç§°:", showInput: true});
        if(n) {
            const data = appState.mode === 'character' ? appState.charData : appState.prodData;
            const m = data.modules.find(x => x.id === mid);
            m.categories.push({name: n, tags: []});
            m.activeCat = m.categories.length - 1;
            renderModules(); saveState();
        }
    }

    function toggleSettingsPanel(e) { e.stopPropagation(); document.getElementById('settingsDropdown').classList.toggle('open'); }
    function saveState() { appState.age = document.getElementById('ageInput').value; localStorage.setItem('prompt_v10_state', JSON.stringify(appState)); }
    function saveSettings() { appState.apiKey = document.getElementById('apiKeyInput').value.trim(); saveState(); }
    function selectBasic(t) { const data = appState.mode === 'character' ? appState.charData : appState.prodData; data.selSubject = (data.selSubject === t ? null : t); renderBasic(); saveState(); }
    function delBasic(t) { const data = appState.mode === 'character' ? appState.charData : appState.prodData; data.subjects = data.subjects.filter(i => i !== t); renderBasic(); saveState(); }
    function toggleTag(mid, t) { const data = appState.mode === 'character' ? appState.charData : appState.prodData; if(!data.selTags[mid]) data.selTags[mid] = []; if(data.selTags[mid].includes(t)) data.selTags[mid] = data.selTags[mid].filter(x => x !== t); else data.selTags[mid].push(t); renderModules(); saveState(); }
    function setCat(mid, i) { const data = appState.mode === 'character' ? appState.charData : appState.prodData; data.modules.find(x => x.id === mid).activeCat = i; renderModules(); saveState(); }
    
    async function deleteModule(id) { 
        const ok = await showModal({msg: "ç¡®å®šåˆ é™¤è¯¥æ¨¡å—ï¼Ÿ"});
        if(ok) { 
            const data = appState.mode === 'character' ? appState.charData : appState.prodData; 
            data.modules = data.modules.filter(x => x.id !== id); 
            renderModules(); saveState(); 
        } 
    }
    
    async function addNewModule() { 
        const t = await showModal({msg: "æ–°è¯åº“æ¨¡å—åç§°:", showInput: true});
        if(t) { 
            const data = appState.mode === 'character' ? appState.charData : appState.prodData; 
            data.modules.push({ id: 'm'+Date.now(), title: t, activeCat: 0, categories: [{name:'é»˜è®¤', tags:[]}] }); 
            renderModules(); saveState(); 
        } 
    }

    function delTag(mid, t) { const data = appState.mode === 'character' ? appState.charData : appState.prodData; const m = data.modules.find(x => x.id === mid); m.categories[m.activeCat].tags = m.categories[m.activeCat].tags.filter(x => x !== t); if(data.selTags[mid]) data.selTags[mid] = data.selTags[mid].filter(x => x !== t); renderModules(); saveState(); }
    function toggleTheme() { appState.theme = appState.theme === 'dark' ? 'light' : 'dark'; updateUIThemes(); saveState(); }
    function updateUIThemes() { document.body.className = appState.theme + '-theme'; document.getElementById('themeBtn').innerText = appState.theme === 'dark' ? 'â˜€ï¸ æµ…è‰²' : 'ğŸŒ™ æ·±è‰²'; }
    function toggleBtnState(key) { if(key === 'useAI') appState.useAI = !appState.useAI; else { const data = appState.mode === 'character' ? appState.charData : appState.prodData; data.useSpecial = !data.useSpecial; } updateToggleButtons(); saveState(); }
    function updateToggleButtons() { document.getElementById('aiToggle').className = `btn-toggle ${appState.useAI ? 'active' : ''}`; const data = appState.mode === 'character' ? appState.charData : appState.prodData; const sp = document.getElementById('specialToggle'); sp.innerText = `${appState.mode === 'character' ? 'æ¢è£…å‚è€ƒ' : 'ä¸Šèº«æ•ˆæœ'}: ${data.useSpecial ? 'ON' : 'OFF'}`; sp.className = `btn-toggle ${data.useSpecial ? 'active' : ''}`; }
    
    async function generatePrompt() {
        const data = appState.mode === 'character' ? appState.charData : appState.prodData;
        let p = []; if(appState.mode==='character' && appState.age) p.push(appState.age+"å²");
        if(data.selSubject) p.push(data.selSubject);
        data.modules.forEach(m => { if(data.selTags[m.id]?.length) p.push(data.selTags[m.id].join(', ')); });
        let res = p.join(', '); if(!res) return;
        if(data.useSpecial) res = (appState.mode==='character' ? "å‚è€ƒå›¾æ¢è£…æ¨¡å¼ï¼š" : "äº§å“å®é™…ç©¿æˆ´ä¸Šèº«æ•ˆæœï¼š") + res;
        if(appState.mode==='product') res = "äº§å“æ‘„å½±, " + res + ", 8kæé«˜ç”»è´¨";
        if(appState.useAI && appState.apiKey) {
            const btn = document.getElementById('genBtn'); btn.innerText = "AI æ¶¦è‰²ä¸­...";
            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${appState.apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system", content:"ä½ æ˜¯ä¸€ä¸ªç»˜å›¾æç¤ºè¯ä¸“å®¶ï¼Œç›´æ¥è¿”å›æ‰©å……åçš„ä¸­æ–‡æè¿°ã€‚"}, {role:"user", content:res}] })
                });
                const aiData = await response.json(); res = aiData.choices[0].message.content;
            } catch(e) { showModal({msg: "AIè¿æ¥å¤±è´¥"}); }
            btn.innerHTML = "ğŸš€<span>ç”Ÿæˆè¯</span>";
        }
        document.getElementById('resultBox').value = res; addToHistory(res);
    }

    function addToHistory(t) { const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); appState.history.unshift({t, time}); if(appState.history.length > 20) appState.history.pop(); updateHistoryUI(); saveState(); }
    function updateHistoryUI() { document.getElementById('histCount').innerText = appState.history.length; document.getElementById('historyList').innerHTML = appState.history.map(x => `<div class="history-item" onclick="document.getElementById('resultBox').value='${x.t.replace(/'/g, "\\'")}';toggleHistory()"><div>${x.t}</div><div style="flex:none; margin-left:10px;">${x.time}</div></div>`).join(''); }
    function toggleHistory() { document.getElementById('historyList').classList.toggle('open'); }
    
    async function clearAllHistory() { 
        const ok = await showModal({msg: "æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Ÿ"});
        if(ok) { appState.history = []; updateHistoryUI(); saveState(); } 
    }
    
    function clearResult() { document.getElementById('resultBox').value = ''; }
    function copyResult() { const b = document.getElementById('resultBox'); b.select(); document.execCommand('copy'); const btn = document.getElementById('copyBtn'); btn.innerHTML = "âœ…<span>å®Œæˆ</span>"; setTimeout(() => btn.innerHTML = "ğŸ“‹<span>å¤åˆ¶</span>", 1500); }
    function exportData() { const blob = new Blob([JSON.stringify(appState)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Prompt_Config.json'; a.click(); }
    
    function importData(e) { 
        const reader = new FileReader(); 
        reader.onload = async (x) => { 
            try { appState = JSON.parse(x.target.result); saveState(); location.reload(); } 
            catch(e){ await showModal({msg: "å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯"}); } 
        }; 
        reader.readAsText(e.target.files[0]); 
    }
    
    async function resetAll() { 
        const ok = await showModal({msg: "å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å¹¶è¿˜åŸåˆå§‹è®¾ç½®ï¼ç¡®å®šå—ï¼Ÿ"});
        if(ok) { localStorage.clear(); location.reload(); } 
    }

    function initResize() {
        const handle = document.getElementById('resizeHandle');
        const move = (e) => { const y = e.touches ? e.touches[0].clientY : e.clientY; const h = window.innerHeight - y; if(h > 150 && h < 600) { appState.panelHeight = h; document.documentElement.style.setProperty('--panel-height', h + 'px'); } };
        handle.addEventListener('mousedown', () => document.addEventListener('mousemove', move));
        document.addEventListener('mouseup', () => { document.removeEventListener('mousemove', move); saveState(); });
        handle.addEventListener('touchstart', () => document.addEventListener('touchmove', move));
        document.addEventListener('touchend', () => { document.removeEventListener('touchmove', move); saveState(); });
    }

    init();
</script>
</body>
</html>