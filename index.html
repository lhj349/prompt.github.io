<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AI æç¤ºè¯ç¥å™¨ (å…¨è‡ªåŠ¨å­˜æ¡£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --danger: #ef4444;
            --border: #333;
            --tag-bg: #2d2d2d;
            --tag-selected: #6366f1;
            --success: #10b981;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 16px; 
            padding-bottom: 280px; 
        }

        h1 { text-align: center; margin-bottom: 5px; color: var(--accent); }
        .subtitle { text-align: center; color: #666; font-size: 12px; margin-bottom: 5px; }

        /* API é…ç½® */
        .config-card {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 5px;
        }
        .config-input {
            flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff;
            padding: 8px 12px; border-radius: 6px; font-family: monospace; outline: none;
        }

        /* æ¨¡å—å¡ç‰‡ */
        .module-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 18px; 
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .module-header {
            font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .module-header span { font-size: 11px; color: #666; font-weight: normal; }

        /* æ ‡ç­¾ç³»ç»Ÿ */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag {
            background-color: var(--tag-bg);
            border: 1px solid var(--border);
            padding: 6px 10px 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; user-select: none;
        }
        .tag:hover { background-color: #383838; border-color: #555; }
        .tag.active { background-color: var(--tag-selected); color: white; border-color: var(--tag-selected); }
        .tag-close {
            width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #777; font-size: 14px; transition: 0.2s;
        }
        .tag.active .tag-close { color: rgba(255,255,255,0.7); }
        .tag-close:hover { background-color: var(--danger); color: white !important; }

        /* è¾“å…¥æ¡† */
        .input-row { display: flex; gap: 8px; width: 100%; }
        input {
            background-color: #2b2b2b; border: 1px solid var(--border); color: white;
            padding: 8px 12px; border-radius: 6px; flex: 1; outline: none; font-size: 13px;
        }
        input:focus { border-color: var(--accent); background-color: #333; }
        .add-btn {
            background-color: #333; border: 1px solid var(--border); color: #ccc;
            padding: 0 16px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold;
        }
        .add-btn:hover { background-color: #444; color: white; }

        /* åŸºç¡€ä¿¡æ¯å¸ƒå±€ */
        .basic-row { display: flex; gap: 20px; align-items: flex-start; }
        .col-age { width: 80px; }
        .col-main { flex: 1; }
        .input-label { font-size: 11px; color: #888; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

        /* === åº•éƒ¨å›ºå®šæ  === */
        .bottom-panel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: rgba(20, 20, 20, 0.98);
            border-top: 1px solid #333;
            padding: 12px 20px 24px 20px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.5);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center;
            max-height: 48vh;
            backdrop-filter: blur(10px);
        }

        .panel-controls {
            width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-size: 12px; color: #888;
        }
        
        .panel-left { display: flex; align-items: center; gap: 15px; }

        .history-toggle { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; transition: 0.2s; }
        .history-toggle:hover { color: var(--accent); background: #222; }
        
        .clear-history-btn { cursor: pointer; color: #666; font-size: 11px; padding: 2px 6px; border: 1px solid #444; border-radius: 4px; display: none; }
        .clear-history-btn:hover { color: var(--danger); border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* è¾…åŠ©åŠŸèƒ½å¼€å…³åŒºåŸŸ */
        .switches-group { display: flex; align-items: center; gap: 15px; }
        .switch-item { display: flex; align-items: center; gap: 6px; }
        .switch-label { color: #ccc; }
        .switch-label.active { color: var(--accent); font-weight: bold; }

        .output-row { width: 100%; max-width: 800px; display: flex; gap: 10px; margin-bottom: 10px; }
        textarea {
            flex: 1; background-color: #111; border: 1px solid #444; color: #a5b4fc;
            padding: 12px; border-radius: 8px; height: 60px; resize: none; font-family: 'PingFang SC', 'Microsoft YaHei', monospace; font-size: 14px;
            line-height: 1.5;
        }
        
        /* æŒ‰é’®ç»„ */
        .btn { border: none; border-radius: 8px; padding: 0 20px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-gen { background-color: var(--accent); color: white; min-width: 110px; }
        .btn-gen:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        .btn-gen:disabled { background-color: #333; color: #666; cursor: wait; transform: none; }
        
        .btn-act { background-color: #2d2d2d; color: #ccc; border: 1px solid #444; }
        .btn-act:hover { background-color: #3d3d3d; color: white; }
        .btn-clear:hover { background-color: #551111; color: #fca5a5; border-color: #772222; }

        /* å†å²è®°å½•åˆ—è¡¨ */
        .history-list {
            width: 100%; max-width: 800px;
            background: #111; border: 0px solid #333; border-radius: 8px;
            max-height: 0; overflow-y: auto; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .history-list.open { max-height: 180px; border-width: 1px; padding: 8px; margin-bottom: 15px; }
        
        .history-item {
            padding: 10px 12px; border-bottom: 1px solid #222; color: #999; font-size: 13px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border-radius: 4px;
        }
        .history-item:hover { background-color: #222; color: #fff; }
        .hist-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .hist-time { font-size: 11px; color: #555; }

        /* å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }
        
        /* æ¢è£…æŒ‡ä»¤ç‰¹æ®Šé¢œè‰² */
        input#clothPrefixSwitch:checked + .slider { background-color: var(--success); }

    </style>
</head>
<body>

<div class="container">
    <h1>AI æç¤ºè¯ç¥å™¨ <span style="font-size:12px; color:#666; font-weight: normal;">Pro Max</span></h1>
    <div class="subtitle">å®æ—¶çŠ¶æ€ä¿å­˜ Â· å†å²è®°å½• Â· DeepSeek ä¸­æ–‡æ¶¦è‰²</div>

    <!-- API Config -->
    <div class="config-card">
        <div style="font-weight:bold; color:var(--accent); font-size: 13px;">DeepSeek API Key</div>
        <input type="password" id="apiKeyInput" class="config-input" placeholder="è¾“å…¥æ‚¨çš„ sk-..." onblur="saveSettings()">
    </div>

    <!-- 1. åŸºç¡€ä¿¡æ¯ -->
    <div class="module-card">
        <div class="module-header">åŸºç¡€è§’è‰²ä¿¡æ¯ <span>(è‡ªåŠ¨ä¿å­˜)</span></div>
        <div class="basic-row">
            <div class="col-age">
                <div class="input-label">å¹´é¾„</div>
                <input type="number" id="ageInput" placeholder="18" oninput="saveState()" style="width: 60px;">
            </div>
            <div class="col-main">
                <div class="input-label">è§’è‰²ä¸»ä½“ (å•é€‰/å¤šé€‰)</div>
                <div class="tags-container" id="basicTags"></div>
                <div class="input-row">
                    <input type="text" id="basicInput" placeholder="æ·»åŠ è§’è‰²æ ‡ç­¾...">
                    <button class="add-btn" onclick="addBasicTag()">ï¼‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. åŠ¨æ€æ¨¡å— -->
    <div id="dynamicModules" style="display: flex; flex-direction: column; gap: 16px;"></div>
</div>

<!-- åº•éƒ¨é¢æ¿ -->
<div class="bottom-panel">
    <div class="panel-controls">
        <div class="panel-left">
            <div class="history-toggle" onclick="toggleHistory()">
                <span id="histArrow">â–²</span> å†å² (<span id="histCount">0</span>)
            </div>
            <div class="clear-history-btn" id="clearHistoryBtn" onclick="clearAllHistory()">æ¸…é™¤å†å²</div>
        </div>
        <div class="switches-group">
            <span style="cursor:pointer; text-decoration:underline;" onclick="resetAll()">é‡ç½®ä¸€åˆ‡</span>
            
            <!-- æ¢è£…æŒ‡ä»¤å¼€å…³ -->
            <div class="switch-item" title="å¼€å¯åè‡ªåŠ¨æ·»åŠ ï¼šæŒ‰ç…§å‚è€ƒå›¾å¸®æˆ‘æŠŠè¿™ä¸ªè¡£æœç©¿åˆ°æ¨¡ç‰¹èº«ä¸Š">
                <label class="switch">
                    <input type="checkbox" id="clothPrefixSwitch" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
                <span class="switch-label" id="clothLabel">æ¢è£…æŒ‡ä»¤</span>
            </div>

            <!-- AI æ¶¦è‰²å¼€å…³ -->
            <div class="switch-item">
                <label class="switch">
                    <input type="checkbox" id="aiSwitch" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">AI æ¶¦è‰²</span>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <div class="history-list" id="historyList"></div>

    <div class="output-row">
        <textarea id="resultBox" placeholder="ç”Ÿæˆçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <button class="btn btn-gen" id="genBtn" onclick="generatePrompt()" style="height: 100%;">ç”Ÿæˆ</button>
        </div>
    </div>
    <div style="width: 100%; max-width: 800px; display: flex; gap: 10px;">
        <button class="btn btn-act btn-clear" onclick="clearResult()" style="flex: 1; padding: 8px 0;">æ¸…ç©ºæ¡†å†…</button>
        <button class="btn btn-act" onclick="copyResult()" style="flex: 2; padding: 8px 0; background-color: #3e41b0; border: none; color: white;">å¤åˆ¶æç¤ºè¯</button>
    </div>
</div>

<script>
    // === 0. é»˜è®¤æ•°æ® ===
    const DEFAULT_BASIC = ['ç”·æ€§', 'å¥³æ€§', 'æƒ…ä¾£', 'å§å¦¹', 'å…„å¼Ÿ', ];
    const DEFAULT_MODULES = [
        { id: 'scene', title: 'ğŸï¸ åœºæ™¯', tags: ['ç™½åº•', 'æ±Ÿè¾¹æ¡¥æ¢æ—', 'å®ä¼Ÿå»ºç­‘', 'åŸå¸‚è¡—å¤´', 'é‡‡çŸ³åœº','æˆ·å¤–éœ²è¥', 'åŸå§‹æ£®æ—'] },
        { id: 'style', title: 'ğŸ¤·â€â™€ï¸ å§¿åŠ¿/åŠ¨ä½œ', tags: ['ç«™ç«‹', 'ä¾é ', 'é¢å¯¹é•œå¤´', 'è·‘æ­¥', 'å•æ‰‹æ’å£è¢‹', 'ç«™åœ¨åŸåœ°'] },
        { id: 'appear', title: 'ğŸ˜ è¡¨æƒ…', tags: ['å¾®ç¬‘', 'å¤§ç¬‘', 'å¼€å¿ƒçš„ç¬‘','æ´‹æ´‹å¾—æ„'] },
        { id: 'makeup', title: 'ğŸ’„ å¦†å®¹/å¤´å‘', tags: ['éŸ©ç³»åº”æ´å¦†é€ ', 'æ—¥ç³»å¦†å®¹','æ¸¯é£å¦†' ,'é•¿å‘','çŸ­å‘','é”¡çº¸çƒ«','æ‘©æ ¹'] },
        { id: 'cloth', title: 'ğŸ‘— æœè£…', tags: ['é»‘è‰²é•¿è£¤', 'ç‘œä¼½è£¤', 'æ¯›è¡£', 'çŸ­è¢–', 'é®é˜³å¸½','é»‘è‰²å¢¨é•œ'] },
        { id: 'light', title: 'ğŸ’¡ å…‰å½±', tags: ['è‡ªç„¶é‡‡å…‰', 'åŠ¨æ€æ¨¡ç³Š','æš–è‰²è°ƒ','æµ‹å…‰','ä¾§é€†å…‰','çª—æˆ·å…‰','å‘ä¸å…‰','ç«å…‰','ä¸­æ™¯','è¿œæ™¯','æ­£é¢å…‰','ä¾§é¢è§†è§’','å±…ä¸­æ„å›¾','è½®å»“å…‰'] },
        { id: 'cam', title: 'ğŸ“· è®¾å¤‡/é£æ ¼', tags: ['æ‰‹æœºæ‘„å½±', 'ç´¢å°¼ç›¸æœº', 'å°¼åº·ç›¸æœº', 'å¯Œå£«èƒ¶ç‰‡é£', 'çºªå®æ‘„å½±', 'è½»ç„¦æ„Ÿ', 'ç”µå½±è´¨æ„Ÿ', 'åŸå¸‚æ‘„å½±', 'å¤æ—©é£', 'å¤é£æ‘„å½±', 'æŸ¯è¾¾æ‘„å½±', 'å°æ¸…æ–°', 'æˆ·å¤–æ‘„å½±', 'å†™çœŸæ‘„å½±', 'è¡—å¤´æ‘„å½±'] },
        { id: 'post', title: 'ğŸ’» åæœŸ', tags: ['4kç”»è´¨', 'è™šå¹»å¼•æ“', 'OC renderer', 'ç™¾ä¸‡åƒç´ ', 'è¶…é«˜æ¸…', 'è¶…é«˜åˆ†è¾¨ç‡', '8k'] },
        { id: 'other', title: 'ğŸ¤¡ å…¶ä»–', tags: ['ä¸“ä¸šæ‘„å½±', 'ä¸“ä¸šåæœŸ', 'ä¸“ä¸šç¼–è¾‘', 'ä¸“ä¸šæ¸²æŸ“', 'ä¸“ä¸šæ¸²æŸ“å™¨', 'ä¸“ä¸šæ¸²æŸ“è½¯ä»¶', 'ä¸“ä¸šæ¸²æŸ“æ’ä»¶'] }
    ];

    // === 1. çŠ¶æ€ç®¡ç† ===
    let appState = {
        basicSubjects: [...DEFAULT_BASIC],
        modulesData: JSON.parse(JSON.stringify(DEFAULT_MODULES)),
        selSubject: null,
        selTags: {}, 
        age: '',
        apiKey: '',
        useAI: true,
        useClothPrefix: false, 
        history: [] 
    };

    // === 2. åˆå§‹åŒ– ===
    function init() {
        loadState(); 
        renderUI();
        document.getElementById('basicInput').addEventListener('keydown', (e) => e.key==='Enter' && addBasicTag());
    }

    function loadState() {
        const json = localStorage.getItem('prompt_gen_full_state');
        if (json) {
            const saved = JSON.parse(json);
            appState = { ...appState, ...saved };
        }
        document.getElementById('apiKeyInput').value = appState.apiKey || '';
        document.getElementById('ageInput').value = appState.age || '';
        document.getElementById('aiSwitch').checked = appState.useAI;
        document.getElementById('clothPrefixSwitch').checked = appState.useClothPrefix || false;
        
        updateLabelStyles();

        appState.modulesData.forEach(m => {
            if (!appState.selTags[m.id]) appState.selTags[m.id] = [];
        });
        updateHistoryUI();
    }

    function saveState() {
        appState.age = document.getElementById('ageInput').value;
        localStorage.setItem('prompt_gen_full_state', JSON.stringify(appState));
    }

    function saveSettings() {
        appState.apiKey = document.getElementById('apiKeyInput').value.trim();
        appState.useAI = document.getElementById('aiSwitch').checked;
        appState.useClothPrefix = document.getElementById('clothPrefixSwitch').checked;
        updateLabelStyles();
        saveState();
    }

    function updateLabelStyles() {
        const label = document.getElementById('clothLabel');
        if (appState.useClothPrefix) label.classList.add('active');
        else label.classList.remove('active');
    }

    function resetAll() {
        if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ã€è¯åº“å’Œå†å²è®°å½•å—ï¼Ÿ')) {
            localStorage.removeItem('prompt_gen_full_state');
            location.reload();
        }
    }

    // === 3. UI æ¸²æŸ“ ===
    function renderUI() {
        renderBasic();
        renderModules();
    }

    function renderBasic() {
        const box = document.getElementById('basicTags');
        box.innerHTML = '';
        appState.basicSubjects.forEach(t => {
            const el = document.createElement('div');
            el.className = `tag ${appState.selSubject === t ? 'active' : ''}`;
            el.innerHTML = `<span>${t}</span><span class="tag-close" onclick="event.stopPropagation();delBasic('${t}')">Ã—</span>`;
            el.onclick = () => {
                appState.selSubject = (appState.selSubject === t ? null : t);
                saveState();
                renderBasic();
            };
            box.appendChild(el);
        });
    }

    function renderModules() {
        const container = document.getElementById('dynamicModules');
        container.innerHTML = '';
        appState.modulesData.forEach(m => {
            const card = document.createElement('div');
            card.className = 'module-card';
            card.innerHTML = `
                <div class="module-header">${m.title}</div>
                <div class="tags-container" id="tags-${m.id}"></div>
                <div class="input-row">
                    <input type="text" id="in-${m.id}" placeholder="æ·»åŠ è‡ªå®šä¹‰è¯æ¡...">
                    <button class="add-btn" onclick="addModuleTag('${m.id}')">ï¼‹</button>
                </div>
            `;
            container.appendChild(card);
            renderModuleTags(m.id);
            document.getElementById(`in-${m.id}`).addEventListener('keydown', (e) => e.key==='Enter' && addModuleTag(m.id));
        });
    }

    function renderModuleTags(mid) {
        const box = document.getElementById(`tags-${mid}`);
        box.innerHTML = '';
        const mod = appState.modulesData.find(m => m.id === mid);
        mod.tags.forEach(t => {
            const isSel = appState.selTags[mid].includes(t);
            const el = document.createElement('div');
            el.className = `tag ${isSel ? 'active' : ''}`;
            el.innerHTML = `<span>${t}</span><span class="tag-close" onclick="event.stopPropagation();delModuleTag('${mid}','${t}')">Ã—</span>`;
            el.onclick = () => {
                if (isSel) appState.selTags[mid] = appState.selTags[mid].filter(i => i !== t);
                else appState.selTags[mid].push(t);
                saveState();
                renderModuleTags(mid);
            };
            box.appendChild(el);
        });
    }

    function addBasicTag() {
        const input = document.getElementById('basicInput');
        const val = input.value.trim();
        if (val && !appState.basicSubjects.includes(val)) {
            appState.basicSubjects.push(val);
            appState.selSubject = val;
            saveState();
            renderBasic();
        }
        input.value = '';
    }

    function delBasic(t) {
        appState.basicSubjects = appState.basicSubjects.filter(i => i !== t);
        if (appState.selSubject === t) appState.selSubject = null;
        saveState();
        renderBasic();
    }

    function addModuleTag(mid) {
        const input = document.getElementById(`in-${mid}`);
        const val = input.value.trim();
        if (val) {
            const mod = appState.modulesData.find(m => m.id === mid);
            if (!mod.tags.includes(val)) mod.tags.push(val);
            if (!appState.selTags[mid].includes(val)) appState.selTags[mid].push(val);
            saveState();
            renderModuleTags(mid);
            input.value = '';
        }
    }

    function delModuleTag(mid, t) {
        const mod = appState.modulesData.find(m => m.id === mid);
        mod.tags = mod.tags.filter(i => i !== t);
        appState.selTags[mid] = appState.selTags[mid].filter(i => i !== t);
        saveState();
        renderModuleTags(mid);
    }

    // === 5. ç”Ÿæˆé€»è¾‘ ===
    async function generatePrompt() {
        saveState();
        
        let parts = [];
        if(appState.age) parts.push(`${appState.age}å²`);
        if(appState.selSubject) parts.push(appState.selSubject);
        appState.modulesData.forEach(m => {
            if(appState.selTags[m.id] && appState.selTags[m.id].length) {
                parts.push(appState.selTags[m.id].join('ã€'));
            }
        });

        const rawPrompt = parts.join(', ');
        if(!rawPrompt) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾ï¼'); return; }

        const outBox = document.getElementById('resultBox');
        const btn = document.getElementById('genBtn');
        let finalPrompt = rawPrompt;

        const CLOTH_PREFIX = "æŒ‰ç…§å‚è€ƒå›¾å¸®æˆ‘æŠŠè¿™ä¸ªè¡£æœç©¿åˆ°æ¨¡ç‰¹èº«ä¸Šï¼Œ";

        if (appState.useAI) {
            if (!appState.apiKey) { alert('è¯·å…ˆè¾“å…¥ DeepSeek API Key'); return; }
            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";
            outBox.value = "DeepSeek æ­£åœ¨ä¸ºæ‚¨æ¶¦è‰²ä¸­æ–‡æç¤ºè¯...";
            
            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${appState.apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { 
                                role: "system", 
                                content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIç»˜ç”»æç¤ºè¯ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„å…³é”®è¯ç»„åˆå¹¶æ‰©å……æˆä¸€æ®µç»†èŠ‚ä¸°å¯Œã€æ„å›¾ç²¾ç¾ã€æè¿°ç”ŸåŠ¨çš„ä¸­æ–‡ç»˜ç”»æç¤ºè¯ï¼ˆPromptï¼‰ã€‚è¯·ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚" 
                            },
                            { role: "user", content: `å…³é”®è¯: [${rawPrompt}]` }
                        ],
                        stream: false
                    })
                });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                finalPrompt = data.choices[0].message.content;
            } catch(e) {
                finalPrompt = "API è°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹è¯: " + rawPrompt;
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆ";
            }
        }

        if (appState.useClothPrefix) {
            finalPrompt = CLOTH_PREFIX + finalPrompt;
        }

        outBox.value = finalPrompt;
        addToHistory(finalPrompt);
    }

    // === 6. å†å²è®°å½•ç®¡ç† ===
    function addToHistory(text) {
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        appState.history.unshift({ text: text, time: timeStr });
        if(appState.history.length > 20) appState.history.pop();
        saveState();
        updateHistoryUI();
    }

    function updateHistoryUI() {
        const list = document.getElementById('historyList');
        const countSpan = document.getElementById('histCount');
        const clearBtn = document.getElementById('clearHistoryBtn');
        
        countSpan.innerText = appState.history.length;
        
        // å¦‚æœæœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
        if(appState.history.length > 0) {
            clearBtn.style.display = 'inline-block';
        } else {
            clearBtn.style.display = 'none';
            list.classList.remove('open');
            document.getElementById('histArrow').innerText = 'â–²';
        }
        
        list.innerHTML = '';
        appState.history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="hist-text" title="${item.text}">${item.text}</div>
                <div class="hist-time">${item.time}</div>
            `;
            div.onclick = () => {
                document.getElementById('resultBox').value = item.text;
            };
            list.appendChild(div);
        });
    }

    function clearAllHistory() {
        if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”Ÿæˆçš„å†å²è®°å½•å—ï¼Ÿ')) {
            appState.history = [];
            saveState();
            updateHistoryUI();
        }
    }

    function toggleHistory() {
        if(appState.history.length === 0) return;
        const list = document.getElementById('historyList');
        list.classList.toggle('open');
        const arrow = document.getElementById('histArrow');
        arrow.innerText = list.classList.contains('open') ? 'â–¼' : 'â–²';
    }

    function clearResult() { document.getElementById('resultBox').value = ''; }
    
    function copyResult() {
        const el = document.getElementById('resultBox');
        if(!el.value) return;
        el.select(); 
        document.execCommand('copy');
        const copyBtn = event.target;
        const oldText = copyBtn.innerText;
        copyBtn.innerText = "å·²å¤åˆ¶ï¼";
        setTimeout(() => copyBtn.innerText = oldText, 2000);
    }

    init();
</script>

</body>
</html>