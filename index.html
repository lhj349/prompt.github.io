<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>AI æç¤ºè¯ç¥å™¨ (å…¨è‡ªåŠ¨å­˜æ¡£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --danger: #ef4444;
            --border: #333;
            --tag-bg: #2d2d2d;
            --tag-selected: #6366f1;
            --success: #10b981;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            /* é˜²æ­¢ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 16px; 
            padding-bottom: 300px; /* ä¸ºåº•éƒ¨é¢æ¿ç•™å‡ºæ›´å¤šç©ºé—´ */
        }

        h1 { text-align: center; margin-bottom: 5px; color: var(--accent); font-size: 1.5rem; }
        .subtitle { text-align: center; color: #666; font-size: 12px; margin-bottom: 5px; }

        /* API é…ç½® */
        .config-card {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 5px;
        }
        .config-input {
            flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff;
            padding: 8px 12px; border-radius: 6px; font-family: monospace; outline: none;
            font-size: 14px;
        }

        /* æ¨¡å—å¡ç‰‡ */
        .module-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 18px; 
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .module-header {
            font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .module-header span { font-size: 11px; color: #666; font-weight: normal; }

        /* æ ‡ç­¾ç³»ç»Ÿ */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag {
            background-color: var(--tag-bg);
            border: 1px solid var(--border);
            padding: 8px 12px; /* å¢å¤§è§¦æ‘¸é¢ç§¯ */
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; user-select: none;
        }
        .tag:hover { background-color: #383838; border-color: #555; }
        .tag.active { background-color: var(--tag-selected); color: white; border-color: var(--tag-selected); }
        .tag-close {
            width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #777; font-size: 16px; transition: 0.2s;
        }
        .tag.active .tag-close { color: rgba(255,255,255,0.7); }

        /* è¾“å…¥æ¡† */
        .input-row { display: flex; gap: 8px; width: 100%; }
        input {
            background-color: #2b2b2b; border: 1px solid var(--border); color: white;
            padding: 10px 12px; border-radius: 6px; flex: 1; outline: none; font-size: 14px;
        }
        input:focus { border-color: var(--accent); background-color: #333; }
        .add-btn {
            background-color: #333; border: 1px solid var(--border); color: #ccc;
            padding: 0 16px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold;
        }

        /* åŸºç¡€ä¿¡æ¯å¸ƒå±€ */
        .basic-row { display: flex; gap: 20px; align-items: flex-start; }
        .col-age { width: 80px; }
        .col-main { flex: 1; }
        .input-label { font-size: 11px; color: #888; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

        /* === åº•éƒ¨å›ºå®šæ  === */
        .bottom-panel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: rgba(20, 20, 20, 0.98);
            border-top: 1px solid #333;
            padding: 12px 15px 20px 15px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.5);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        .panel-controls {
            width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-size: 12px; color: #888; flex-wrap: wrap; gap: 10px;
        }
        
        .panel-left { display: flex; align-items: center; gap: 12px; }

        .history-toggle { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 4px; background: #222; }
        
        .clear-history-btn { cursor: pointer; color: #666; font-size: 11px; padding: 4px 8px; border: 1px solid #444; border-radius: 4px; display: none; }

        /* è¾…åŠ©åŠŸèƒ½å¼€å…³åŒºåŸŸ */
        .switches-group { display: flex; align-items: center; gap: 12px; }
        .switch-item { display: flex; align-items: center; gap: 4px; }
        .switch-label { color: #ccc; font-size: 12px; }
        .switch-label.active { color: var(--accent); font-weight: bold; }

        .output-row { width: 100%; max-width: 800px; display: flex; gap: 10px; margin-bottom: 10px; }
        textarea {
            flex: 1; background-color: #111; border: 1px solid #444; color: #a5b4fc;
            padding: 10px; border-radius: 8px; height: 70px; resize: none; 
            font-family: 'PingFang SC', 'Microsoft YaHei', monospace; font-size: 14px;
            line-height: 1.4;
        }
        
        /* æŒ‰é’®ç»„ */
        .btn { border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-gen { background-color: var(--accent); color: white; min-width: 80px; }
        
        .btn-act { background-color: #2d2d2d; color: #ccc; border: 1px solid #444; }
        .btn-copy { background-color: #3e41b0; color: white; border: none; flex: 2; }

        /* å†å²è®°å½•åˆ—è¡¨ */
        .history-list {
            width: 100%; max-width: 800px;
            background: #111; border: 0px solid #333; border-radius: 8px;
            max-height: 0; overflow-y: auto; transition: all 0.3s ease;
        }
        .history-list.open { max-height: 150px; border-width: 1px; padding: 8px; margin-bottom: 15px; }
        
        .history-item {
            padding: 12px; border-bottom: 1px solid #222; color: #999; font-size: 13px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* === æ‰‹æœºç«¯é€‚é…åª’ä½“æŸ¥è¯¢ === */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding-bottom: 320px; gap: 12px; }
            h1 { font-size: 1.2rem; }
            
            .basic-row { flex-direction: column; gap: 15px; }
            .col-age { width: 100%; }
            .col-age input { width: 100% !important; box-sizing: border-box; }
            
            .module-card { padding: 15px; }
            
            .panel-controls { justify-content: center; }
            .output-row { flex-direction: column; }
            .btn-gen { height: 45px; width: 100%; }
            textarea { height: 80px; }

            .config-card { flex-direction: column; align-items: flex-start; gap: 8px; }
            .config-input { width: 100%; box-sizing: border-box; }

            /* è°ƒæ•´æŒ‰é’®åœ¨æ‰‹æœºä¸Šçš„å¸ƒå±€ */
            .action-group { width: 100%; display: flex; gap: 10px; }
            .btn-act { padding: 12px 0; }
        }

    </style>
</head>
<body>

<div class="container">
    <h1>AI æç¤ºè¯ç¥å™¨ <span style="font-size:12px; color:#666; font-weight: normal;">Pro Max</span></h1>
    <div class="subtitle">æ‰‹æœºé€‚é…ç‰ˆ Â· å®æ—¶è‡ªåŠ¨å­˜æ¡£ Â· å†å²è®°å½•</div>

    <!-- API Config -->
    <div class="config-card">
        <div style="font-weight:bold; color:var(--accent); font-size: 13px;">DeepSeek API Key</div>
        <input type="password" id="apiKeyInput" class="config-input" placeholder="sk-..." onblur="saveSettings()">
    </div>

    <!-- 1. åŸºç¡€ä¿¡æ¯ -->
    <div class="module-card">
        <div class="module-header">åŸºç¡€è§’è‰²ä¿¡æ¯ <span>(è‡ªåŠ¨ä¿å­˜)</span></div>
        <div class="basic-row">
            <div class="col-age">
                <div class="input-label">å¹´é¾„</div>
                <input type="number" id="ageInput" placeholder="18" oninput="saveState()" style="width: 60px;">
            </div>
            <div class="col-main">
                <div class="input-label">è§’è‰²ä¸»ä½“ (å•é€‰/å¤šé€‰)</div>
                <div class="tags-container" id="basicTags"></div>
                <div class="input-row">
                    <input type="text" id="basicInput" placeholder="æ·»åŠ è§’è‰²æ ‡ç­¾...">
                    <button class="add-btn" onclick="addBasicTag()">ï¼‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. åŠ¨æ€æ¨¡å— -->
    <div id="dynamicModules" style="display: flex; flex-direction: column; gap: 16px;"></div>
</div>

<!-- åº•éƒ¨é¢æ¿ -->
<div class="bottom-panel">
    <div class="panel-controls">
        <div class="panel-left">
            <div class="history-toggle" onclick="toggleHistory()">
                <span id="histArrow">â–²</span> å†å²(<span id="histCount">0</span>)
            </div>
            <div class="clear-history-btn" id="clearHistoryBtn" onclick="clearAllHistory()">æ¸…é™¤</div>
        </div>
        <div class="switches-group">
            <span style="cursor:pointer; text-decoration:underline; font-size:11px;" onclick="resetAll()">é‡ç½®</span>
            <div class="switch-item">
                <label class="switch">
                    <input type="checkbox" id="clothPrefixSwitch" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
                <span class="switch-label" id="clothLabel">æ¢è£…</span>
            </div>
            <div class="switch-item">
                <label class="switch">
                    <input type="checkbox" id="aiSwitch" onchange="saveSettings()">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">AIæ¶¦è‰²</span>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <div class="history-list" id="historyList"></div>

    <div class="output-row">
        <textarea id="resultBox" placeholder="ç”Ÿæˆçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
        <button class="btn btn-gen" id="genBtn" onclick="generatePrompt()">ç”Ÿæˆ</button>
    </div>
    
    <div class="action-group" style="width: 100%; max-width: 800px; display: flex; gap: 10px;">
        <button class="btn btn-act" onclick="clearResult()" style="flex: 1;">æ¸…ç©º</button>
        <button class="btn btn-act btn-copy" id="copyBtn" onclick="copyResult()">å¤åˆ¶ç»“æœ</button>
    </div>
</div>

<script>
    // === é€»è¾‘éƒ¨åˆ†ä¿æŒå®Œå…¨ä¸€è‡´ï¼Œä»…åšéƒ¨åˆ†UIå…¼å®¹è°ƒæ•´ ===
    const DEFAULT_BASIC = ['ç”·æ€§', 'å¥³æ€§', 'æƒ…ä¾£', 'å§å¦¹', 'å…„å¼Ÿ'];
    const DEFAULT_MODULES = [
        { id: 'scene', title: 'ğŸï¸ åœºæ™¯', tags: ['ç™½åº•', 'æ±Ÿè¾¹æ¡¥æ¢æ—', 'å®ä¼Ÿå»ºç­‘', 'åŸå¸‚è¡—å¤´', 'é‡‡çŸ³åœº','æˆ·å¤–éœ²è¥', 'åŸå§‹æ£®æ—'] },
        { id: 'style', title: 'ğŸ¤·â€â™€ï¸ å§¿åŠ¿/åŠ¨ä½œ', tags: ['ç«™ç«‹', 'ä¾é ', 'é¢å¯¹é•œå¤´', 'è·‘æ­¥', 'å•æ‰‹æ’å£è¢‹', 'ç«™åœ¨åŸåœ°'] },
        { id: 'appear', title: 'ğŸ˜ è¡¨æƒ…', tags: ['å¾®ç¬‘', 'å¤§ç¬‘', 'å¼€å¿ƒçš„ç¬‘','æ´‹æ´‹å¾—æ„'] },
        { id: 'makeup', title: 'ğŸ’„ å¦†å®¹/å¤´å‘', tags: ['éŸ©ç³»åº”æ´å¦†é€ ', 'æ—¥ç³»å¦†å®¹','æ¸¯é£å¦†' ,'é•¿å‘','çŸ­å‘','é”¡çº¸çƒ«','æ‘©æ ¹'] },
        { id: 'cloth', title: 'ğŸ‘— æœè£…', tags: ['é»‘è‰²é•¿è£¤', 'ç‘œä¼½è£¤', 'æ¯›è¡£', 'çŸ­è¢–', 'é®é˜³å¸½','é»‘è‰²å¢¨é•œ'] },
        { id: 'light', title: 'ğŸ’¡ å…‰å½±', tags: ['è‡ªç„¶é‡‡å…‰', 'åŠ¨æ€æ¨¡ç³Š','æš–è‰²è°ƒ','æµ‹å…‰','ä¾§é€†å…‰','çª—æˆ·å…‰','å‘ä¸å…‰','ç«å…‰','ä¸­æ™¯','è¿œæ™¯','æ­£é¢å…‰','ä¾§é¢è§†è§’','å±…ä¸­æ„å›¾','è½®å»“å…‰'] },
        { id: 'cam', title: 'ğŸ“· è®¾å¤‡/é£æ ¼', tags: ['æ‰‹æœºæ‘„å½±', 'ç´¢å°¼ç›¸æœº', 'å°¼åº·ç›¸æœº', 'å¯Œå£«èƒ¶ç‰‡é£', 'çºªå®æ‘„å½±', 'è½»ç„¦æ„Ÿ', 'ç”µå½±è´¨æ„Ÿ', 'åŸå¸‚æ‘„å½±', 'å¤æ—©é£', 'å¤é£æ‘„å½±', 'æŸ¯è¾¾æ‘„å½±', 'å°æ¸…æ–°', 'æˆ·å¤–æ‘„å½±', 'å†™çœŸæ‘„å½±', 'è¡—å¤´æ‘„å½±'] },
        { id: 'post', title: 'ğŸ’» åæœŸ', tags: ['4kç”»è´¨', 'è™šå¹»å¼•æ“', 'OC renderer', 'ç™¾ä¸‡åƒç´ ', 'è¶…é«˜æ¸…', 'è¶…é«˜åˆ†è¾¨ç‡', '8k'] },
        { id: 'other', title: 'ğŸ¤¡ å…¶ä»–', tags: ['ä¸“ä¸šæ‘„å½±', 'ä¸“ä¸šåæœŸ', 'ä¸“ä¸šç¼–è¾‘', 'ä¸“ä¸šæ¸²æŸ“', 'ä¸“ä¸šæ¸²æŸ“å™¨', 'ä¸“ä¸šæ¸²æŸ“è½¯ä»¶', 'ä¸“ä¸šæ¸²æŸ“æ’ä»¶'] }
    ];

    let appState = {
        basicSubjects: [...DEFAULT_BASIC],
        modulesData: JSON.parse(JSON.stringify(DEFAULT_MODULES)),
        selSubject: null,
        selTags: {}, 
        age: '',
        apiKey: '',
        useAI: true,
        useClothPrefix: false, 
        history: [] 
    };

    function init() {
        loadState(); 
        renderUI();
        document.getElementById('basicInput').addEventListener('keydown', (e) => e.key==='Enter' && addBasicTag());
    }

    function loadState() {
        const json = localStorage.getItem('prompt_gen_full_state');
        if (json) {
            const saved = JSON.parse(json);
            appState = { ...appState, ...saved };
        }
        document.getElementById('apiKeyInput').value = appState.apiKey || '';
        document.getElementById('ageInput').value = appState.age || '';
        document.getElementById('aiSwitch').checked = appState.useAI;
        document.getElementById('clothPrefixSwitch').checked = appState.useClothPrefix || false;
        
        updateLabelStyles();
        appState.modulesData.forEach(m => {
            if (!appState.selTags[m.id]) appState.selTags[m.id] = [];
        });
        updateHistoryUI();
    }

    function saveState() {
        appState.age = document.getElementById('ageInput').value;
        localStorage.setItem('prompt_gen_full_state', JSON.stringify(appState));
    }

    function saveSettings() {
        appState.apiKey = document.getElementById('apiKeyInput').value.trim();
        appState.useAI = document.getElementById('aiSwitch').checked;
        appState.useClothPrefix = document.getElementById('clothPrefixSwitch').checked;
        updateLabelStyles();
        saveState();
    }

    function updateLabelStyles() {
        const label = document.getElementById('clothLabel');
        if (appState.useClothPrefix) label.classList.add('active');
        else label.classList.remove('active');
    }

    function resetAll() {
        if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å—ï¼Ÿ')) {
            localStorage.removeItem('prompt_gen_full_state');
            location.reload();
        }
    }

    function renderUI() {
        renderBasic();
        renderModules();
    }

    function renderBasic() {
        const box = document.getElementById('basicTags');
        box.innerHTML = '';
        appState.basicSubjects.forEach(t => {
            const el = document.createElement('div');
            el.className = `tag ${appState.selSubject === t ? 'active' : ''}`;
            el.innerHTML = `<span>${t}</span><span class="tag-close" onclick="event.stopPropagation();delBasic('${t}')">Ã—</span>`;
            el.onclick = () => {
                appState.selSubject = (appState.selSubject === t ? null : t);
                saveState(); renderBasic();
            };
            box.appendChild(el);
        });
    }

    function renderModules() {
        const container = document.getElementById('dynamicModules');
        container.innerHTML = '';
        appState.modulesData.forEach(m => {
            const card = document.createElement('div');
            card.className = 'module-card';
            card.innerHTML = `
                <div class="module-header">${m.title}</div>
                <div class="tags-container" id="tags-${m.id}"></div>
                <div class="input-row">
                    <input type="text" id="in-${m.id}" placeholder="æ·»åŠ ...">
                    <button class="add-btn" onclick="addModuleTag('${m.id}')">ï¼‹</button>
                </div>
            `;
            container.appendChild(card);
            renderModuleTags(m.id);
            document.getElementById(`in-${m.id}`).addEventListener('keydown', (e) => e.key==='Enter' && addModuleTag(m.id));
        });
    }

    function renderModuleTags(mid) {
        const box = document.getElementById(`tags-${mid}`);
        box.innerHTML = '';
        const mod = appState.modulesData.find(m => m.id === mid);
        mod.tags.forEach(t => {
            const isSel = appState.selTags[mid].includes(t);
            const el = document.createElement('div');
            el.className = `tag ${isSel ? 'active' : ''}`;
            el.innerHTML = `<span>${t}</span><span class="tag-close" onclick="event.stopPropagation();delModuleTag('${mid}','${t}')">Ã—</span>`;
            el.onclick = () => {
                if (isSel) appState.selTags[mid] = appState.selTags[mid].filter(i => i !== t);
                else appState.selTags[mid].push(t);
                saveState(); renderModuleTags(mid);
            };
            box.appendChild(el);
        });
    }

    function addBasicTag() {
        const input = document.getElementById('basicInput');
        const val = input.value.trim();
        if (val && !appState.basicSubjects.includes(val)) {
            appState.basicSubjects.push(val);
            appState.selSubject = val;
            saveState(); renderBasic();
        }
        input.value = '';
    }

    function delBasic(t) {
        appState.basicSubjects = appState.basicSubjects.filter(i => i !== t);
        if (appState.selSubject === t) appState.selSubject = null;
        saveState(); renderBasic();
    }

    function addModuleTag(mid) {
        const input = document.getElementById(`in-${mid}`);
        const val = input.value.trim();
        if (val) {
            const mod = appState.modulesData.find(m => m.id === mid);
            if (!mod.tags.includes(val)) mod.tags.push(val);
            if (!appState.selTags[mid].includes(val)) appState.selTags[mid].push(val);
            saveState(); renderModuleTags(mid);
        }
        input.value = '';
    }

    function delModuleTag(mid, t) {
        const mod = appState.modulesData.find(m => m.id === mid);
        mod.tags = mod.tags.filter(i => i !== t);
        appState.selTags[mid] = appState.selTags[mid].filter(i => i !== t);
        saveState(); renderModuleTags(mid);
    }

    async function generatePrompt() {
        saveState();
        let parts = [];
        if(appState.age) parts.push(`${appState.age}å²`);
        if(appState.selSubject) parts.push(appState.selSubject);
        appState.modulesData.forEach(m => {
            if(appState.selTags[m.id]?.length) parts.push(appState.selTags[m.id].join('ã€'));
        });

        const rawPrompt = parts.join(', ');
        if(!rawPrompt) { alert('è¯·å…ˆé€‰è¯'); return; }

        const outBox = document.getElementById('resultBox');
        const btn = document.getElementById('genBtn');
        let finalPrompt = rawPrompt;

        if (appState.useAI) {
            if (!appState.apiKey) { alert('è¯·å…ˆè¾“å…¥ API Key'); return; }
            btn.disabled = true; btn.innerText = "...";
            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${appState.apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIç»˜ç”»æç¤ºè¯ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„å…³é”®è¯æ‰©å……æˆä¸€æ®µç”ŸåŠ¨çš„ä¸­æ–‡æç¤ºè¯ï¼Œç›´æ¥è¾“å‡ºç»“æœã€‚" },
                            { role: "user", content: `å…³é”®è¯: [${rawPrompt}]` }
                        ]
                    })
                });
                const data = await res.json();
                finalPrompt = data.choices[0].message.content;
            } catch(e) { finalPrompt = "API å¤±è´¥: " + rawPrompt; }
            btn.disabled = false; btn.innerText = "ç”Ÿæˆ";
        }

        if (appState.useClothPrefix) finalPrompt = "æŒ‰ç…§å‚è€ƒå›¾å¸®æˆ‘æŠŠè¿™ä¸ªè¡£æœç©¿åˆ°æ¨¡ç‰¹èº«ä¸Šï¼Œ" + finalPrompt;
        outBox.value = finalPrompt;
        addToHistory(finalPrompt);
    }

    function addToHistory(text) {
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        appState.history.unshift({ text: text, time: timeStr });
        if(appState.history.length > 20) appState.history.pop();
        saveState(); updateHistoryUI();
    }

    function updateHistoryUI() {
        const list = document.getElementById('historyList');
        const countSpan = document.getElementById('histCount');
        const clearBtn = document.getElementById('clearHistoryBtn');
        countSpan.innerText = appState.history.length;
        clearBtn.style.display = appState.history.length > 0 ? 'inline-block' : 'none';
        list.innerHTML = '';
        appState.history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<div class="hist-text" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%">${item.text}</div><div class="hist-time">${item.time}</div>`;
            div.onclick = () => document.getElementById('resultBox').value = item.text;
            list.appendChild(div);
        });
    }

    function toggleHistory() {
        if(appState.history.length === 0) return;
        const list = document.getElementById('historyList');
        list.classList.toggle('open');
        document.getElementById('histArrow').innerText = list.classList.contains('open') ? 'â–¼' : 'â–²';
    }

    function clearAllHistory() { if(confirm('æ¸…é™¤å†å²ï¼Ÿ')) { appState.history = []; saveState(); updateHistoryUI(); } }
    function clearResult() { document.getElementById('resultBox').value = ''; }
    
    function copyResult() {
        const el = document.getElementById('resultBox');
        if(!el.value) return;
        el.select(); el.setSelectionRange(0, 99999);
        document.execCommand('copy');
        const btn = document.getElementById('copyBtn');
        btn.innerText = "å·²å¤åˆ¶";
        setTimeout(() => btn.innerText = "å¤åˆ¶ç»“æœ", 2000);
    }

    init();
</script>

</body>
</html>